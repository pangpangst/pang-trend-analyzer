<script>
  const WEBHOOK_URL = "/api/analyze";

  const btn = document.getElementById("analyzeBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const statusEl = document.getElementById("status");
  const resultBox = document.getElementById("resultBox");
  const resultContent = document.getElementById("resultContent");

  let lastData = null;

  btn.addEventListener("click", async () => {
    const keyword = document.getElementById("keyword").value.trim();
    const dateRange = document.getElementById("dateRange").value;
    const videoLength = document.getElementById("videoLength").value;
    const minViews = document.getElementById("minViews").value;
    const limit = document.getElementById("limit").value;

    if (!keyword) {
      statusEl.textContent = "키워드를 입력해주세요.";
      statusEl.className = "status error";
      resultBox.style.display = "none";
      downloadBtn.style.display = "none";
      return;
    }

    const payload = {
      keyword,
      dateRange,
      videoLength,
      minViews: Number(minViews),
      limit: Number(limit)
    };

    statusEl.textContent = "분석 요청 전송 중…";
    statusEl.className = "status";
    resultBox.style.display = "none";
    resultContent.textContent = "";
    downloadBtn.style.display = "none";
    lastData = null;

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => null);

      if (!res.ok || !data) {
        statusEl.textContent = "에러: 응답 상태 " + res.status;
        statusEl.className = "status error";
        return;
      }

      lastData = data;
      statusEl.textContent = "분석 완료 (CSV 다운로드 시작)";
      statusEl.className = "status ok";
      resultBox.style.display = "block";
      resultContent.textContent = JSON.stringify(data, null, 2);

      downloadBtn.style.display = "block";
      downloadCsvFromData(data);

    } catch (err) {
      statusEl.textContent = "요청 중 오류 발생";
      statusEl.className = "status error";
    }
  });

  downloadBtn.addEventListener("click", () => {
    if (!lastData) return;
    downloadCsvFromData(lastData);
  });

  function downloadCsvFromData(data) {
    const rows = extractRows(data);
    const csv = toCsv(rows);
    const filename = buildFilename(data);

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  function extractRows(data) {
    const keyword = data?.keyword ?? "";
    const items = Array.isArray(data?.items) ? data.items
               : Array.isArray(data?.results) ? data.results
               : [];

    if (items.length && (items[0]?.id || items[0]?.title)) {
      return items.map((it, idx) => ({
        keyword,
        rank: idx + 1,
        videoId: it.id ?? "",
        title: it.title ?? "",
        channelTitle: it.channelTitle ?? "",
        publishedAt: it.publishedAt ?? "",
        viewCount: it.viewCount ?? it.views ?? "",
        durationSeconds: it.durationSeconds ?? "",
        url: it.url ?? (it.id ? `https://www.youtube.com/watch?v=${it.id}` : "")
      }));
    }

    return [{
      keyword,
      rank: 1,
      videoId: "",
      title: data?.message ?? "",
      channelTitle: "",
      publishedAt: "",
      viewCount: "",
      durationSeconds: "",
      url: ""
    }];
  }

  function buildFilename(data) {
    const k = (data?.keyword || "trend").toString().trim().replace(/\s+/g, "_").slice(0, 30);
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `trend_result_${k}_${y}${m}${day}.csv`;
  }

  function toCsv(rows) {
    const headers = ["keyword","rank","videoId","title","channelTitle","publishedAt","viewCount","durationSeconds","url"];
    const lines = [];
    lines.push(headers.join(","));
    for (const r of rows) {
      const line = headers.map(h => csvEscape(r[h])).join(",");
      lines.push(line);
    }
    return "\uFEFF" + lines.join("\n");
  }

  function csvEscape(v) {
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }
</script>
