<script>
  // ğŸ”— Vercel API ì—”ë“œí¬ì¸íŠ¸
  const WEBHOOK_URL = "/api/analyze";

  const btn = document.getElementById("analyzeBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const statusEl = document.getElementById("status");
  const resultBox = document.getElementById("resultBox");
  const resultContent = document.getElementById("resultContent");

  let lastData = null; // ë§ˆì§€ë§‰ ë¶„ì„ ê²°ê³¼ ì €ì¥(ë‹¤ìš´ë¡œë“œ ì¬í´ë¦­ìš©)

  btn.addEventListener("click", async () => {
    const keyword = document.getElementById("keyword").value.trim();
    const dateRange = document.getElementById("dateRange").value;
    const videoLength = document.getElementById("videoLength").value;
    const minViews = document.getElementById("minViews").value;
    const limit = document.getElementById("limit").value;

    if (!keyword) {
      statusEl.textContent = "í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      statusEl.className = "status error";
      resultBox.style.display = "none";
      downloadBtn.style.display = "none";
      return;
    }

    const payload = {
      keyword,
      dateRange,
      videoLength,
      minViews: Number(minViews),
      limit: Number(limit)
    };

    statusEl.textContent = "ë¶„ì„ ìš”ì²­ ì „ì†¡ ì¤‘â€¦";
    statusEl.className = "status";
    resultBox.style.display = "none";
    resultContent.textContent = "";
    downloadBtn.style.display = "none";
    lastData = null;

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => null);

      if (!res.ok || !data) {
        statusEl.textContent = "ì—ëŸ¬: ì‘ë‹µ ìƒíƒœ " + res.status;
        statusEl.className = "status error";
        return;
      }

      // í™”ë©´ ì¶œë ¥
      lastData = data;
      statusEl.textContent = "ë¶„ì„ ì™„ë£Œ (CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘)";
      statusEl.className = "status ok";
      resultBox.style.display = "block";
      resultContent.textContent = JSON.stringify(data, null, 2);

      // CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™” + ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ
      downloadBtn.style.display = "block";
      downloadCsvFromData(data);

    } catch (err) {
      statusEl.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
      statusEl.className = "status error";
    }
  });

  // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼: ë§ˆì§€ë§‰ ê²°ê³¼ ì¬ë‹¤ìš´ë¡œë“œ
  downloadBtn.addEventListener("click", () => {
    if (!lastData) return;
    downloadCsvFromData(lastData);
  });

  function downloadCsvFromData(data) {
    const rows = extractRows(data);
    const csv = toCsv(rows);
    const filename = buildFilename(data);

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  // API ì‘ë‹µ í˜•íƒœê°€ ë‹¬ë¼ë„ ë™ì‘í•˜ë„ë¡ í¡ìˆ˜
  function extractRows(data) {
    const keyword = data?.keyword ?? "";
    const items = Array.isArray(data?.items) ? data.items
               : Array.isArray(data?.results) ? data.results
               : [];

    // YouTube ì‹¤ë°ì´í„°(items) ê¸°ì¤€ ì»¬ëŸ¼
    if (items.length && (items[0]?.id || items[0]?.title)) {
      return items.map((it, idx) => ({
        keyword,
        rank: idx + 1,
        videoId: it.id ?? "",
        title: it.title ?? "",
        channelTitle: it.channelTitle ?? "",
        publishedAt: it.publishedAt ?? "",
        viewCount: it.viewCount ?? it.views ?? "",
        durationSeconds: it.durationSeconds ?? "",
        url: it.url ?? (it.id ? `https://www.youtube.com/watch?v=${it.id}` : "")
      }));
    }

    // fallback (ì—°ê²°/ì—ì½” ì‘ë‹µ ë“±)
    return [{
      keyword,
      rank: 1,
      videoId: "",
      title: data?.message ?? "",
      channelTitle: "",
      publishedAt: "",
      viewCount: "",
      durationSeconds: "",
      url: ""
    }];
  }

  function buildFilename(data) {
    const k = (data?.keyword || "trend").toString().trim().replace(/\s+/g, "_").slice(0, 30);
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `trend_result_${k}_${y}${m}${day}.csv`;
  }

  function toCsv(rows) {
    // ê³ ì • í—¤ë”
    const headers = ["keyword","rank","videoId","title","channelTitle","publishedAt","viewCount","durationSeconds","url"];
    const lines = [];
    lines.push(headers.join(","));

    for (const r of rows) {
      const line = headers.map(h => csvEscape(r[h])).join(",");
      lines.push(line);
    }

    // Excel í•œê¸€/UTF-8 ê¹¨ì§ ë°©ì§€ìš© BOM
    return "\uFEFF" + lines.join("\n");
  }

  function csvEscape(v) {
    if (v === null || v === undefined) return "";
    const s = String(v);
    // ì½¤ë§ˆ/ë”°ì˜´í‘œ/ê°œí–‰ í¬í•¨ ì‹œ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê³  ë”°ì˜´í‘œëŠ” 2ê°œë¡œ ì´ìŠ¤ì¼€ì´í”„
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }
</script>
